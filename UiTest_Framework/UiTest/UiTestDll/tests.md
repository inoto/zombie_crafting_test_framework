# сущности
## деревья
## игрок
## станок для переработки дерева

# тест кейсы
## деревья
1. Для рубки дерева в инвентаре должен присутствовать топор
2. Дерево не срубается за меньше чем 3 заруба топором.
3. Дерево срубается за 3 заруба топором.
4. Когда дерево срублено, фокус на этом дереве пропадает.
5. Когда игрок срубил дерево, ему добавляется 3 бревна в инвентарь.

## игрок
1. Игрок может перемещаться использую Dpad
2. Фокус игрока на объекте
3. Смена фокуса при смене на другой объект
4. Выход из фокуса
5. Кнопка действия активна/не активна при входе в область/выходе из области предмета

### инвентарь
1. Окно инвентаря показывается
2. Окно инвентаря закрывается
3. Предметы можно удалять. Для этого надо кликнуть предмет, а потом кликнуть ведро
4. Предметы можно перемещать по инвентарю
5. Все слоты инвентаря доступны для предметов
6. Предметы определённого типа стакаются вместе
7. Максимальный размер стака для материалов - 20
8. Не стакающийся тип предметов не стакается

## станок
1. Окно станка открывается
2. Окно станка закрывается
3. Станок обрабатывает предмет
4. Станок не обрабатывает материал, если ячейка результата занята
5. Предмет в ячейке результата стакается
6. Обработка прерывается/продолжается если поставить/убрать не подходящий результат
7. Искомый предмет можно убрать, чтобы прервать обработку
8. Обработку можно ускорить с помощью кнопки, стоит 5 монет
9. Нельзя ускорить обработку если не хватает монет
10. Монеты тратятся при ускорении обработки
11. Ускорение обработки мгновенно завершает процесс обработки
12. Предмет в ячейке результата может стакаться до размера стака результата
13. Обработка не идёт для предметов не из схем обработки
14. Результатом обработки является материал из схемы обработки

# баги
1. Деревья рубятся без топора. При этом иконка действия не активна, но на неё можно нажать, дерево будет рубиться и срубится, как если бы в инветаре был топор.
2. Станок для обработки дерева не правильно учитывает предметы в правом слоте. Если положить в правый слот монеты, а потом в левый слот положить брёвна, то бревно обработается в монету. High
3. При ускорении обработки дерева прогресс обработки не сбрасывается.
4. (спорно, надо обсуждать) При попадании стакающегося предмета в инвентарь предмет кладётся в отдельный слот. Уже находящийся предмет должен быть помещён не в первую свободную ячейку.
5. Иногда дерево не срубается по окончанию рубки. 
6. Ускорение обработки дерева работает даже если не хватает монет. При этом монеты в инвентаре уходят в минус.
7. Cлоты инвентаря [16, 17, 21, 22] ведут себя странно - эксепшн при попытке обновить контент ячейки. когда переносишь туда предмет, то предмет остаётся на начальной позиции. При этом ячейка становится занята, но показывается как пустая.

{"tag":"info","depth":0,"time":"2021-5-2 02:55:05","data":{"name":"Final Error","traceback":"Exception: NullReferenceException: Object reference not set to an instance of an object\nCore.Controllers.CellController.RefreshContent () (at <31bdb29d12e9483b91fc3f056fe35760>:0)\nCore.Controllers.CellController.OnCellChanged () (at <31bdb29d12e9483b91fc3f056fe35760>:0)\nCore.Inventories.Cell.set_Stack (Core.Inventories.Stack value) (at <31bdb29d12e9483b91fc3f056fe35760>:0)\nCore.InventoryBehavior.MoveFromInventory (Core.Inventories.Cell cellFrom, Core.Inventories.Cell cellTo) (at <31bdb29d12e9483b91fc3f056fe35760>:0)\nCore.Controllers.Dialogs.InventoryDialogModel.DropToCell (Core.Inventories.Cell cell) (at <31bdb29d12e9483b91fc3f056fe35760>:0)\nCore.Controllers.CellController.OnDrop (UnityEngine.EventSystems.PointerEventData obj) (at <31bdb29d12e9483b91fc3f056fe35760>:0)\nCore.Controllers.CellContainer.OnDrop (UnityEngine.EventSystems.PointerEventData eventData) (at <31bdb29d12e9483b91fc3f056fe35760>:0)\nAssets.UiTest.TouchInput.UiTestTouchInput+<>c__DisplayClass32_0.<ExecuteDropEvent>b__0 (UnityEngine.EventSystems.IDropHandler o, UnityEngine.EventSystems.BaseEventData a) (at <5c901ac4ad81420db411013d86322d4e>:0)\nUnityEngine.EventSystems.ExecuteEvents.Execute[T] (UnityEngine.GameObject target, UnityEngine.EventSystems.BaseEventData eventData, UnityEngine.EventSystems.ExecuteEvents+EventFunction`1[T1] functor) (at <adbbd84a6a874fb3bb8dd55fe88db73d>:0)\nUnityEngine.EventSystems.ExecuteEvents:Execute(GameObject, BaseEventData, EventFunction`1)\nAssets.UiTest.TouchInput.UiTestTouchInput:ExecuteDropEvent(Vector2)\nAssets.UiTest.TouchInput.UiTestTouchInput:DragEnd(Vector2)\nAssets.UiTest.TestCommands.<Run>d__6:MoveNext()\nUiTest.UiTest.Coroutine.UiTestCoroutine:Run()\nUiTest.UiTest.Coroutine.Scheduler:Update()\nAssets.UiTest.Scripts.UiTestRun:Update()\n"}}

Если потом закрыть и открыть инвентарь, то он больше не закрывается - Blocker!

8. В конфигах нету названия иконок предметов, которые есть в клиенте ТЗ.
Иконки:
    - tool_hatchet_iron
    - Icon_Coin
    - res_wood_1
    - res_plank_1
9. Чит CellSearchByIcon может искать только по Pocket инвентарю, Backpack надо добавить в конфиг

Каюсь - почти для всех багов нашёл рут козы, в основном через изучение декомпилированного кода клиента.


# улучшение фреймворка
* Зарефакторить Commands.cs: вынести куда-нибудь повторяющиеся действия (идеально вынести всё что до и после Run выполняться в коде команде, но тогда хз как лучше поступить в контекстом, чтобы логи писать), CommandsId можно, например, генерить через рефлексию.
* log.txt переименовать в report.txt, чтобы не путало.
* (спорно) Некоторые тестовые команды можно сделать обычными методами, потому что внутри они не используют yield return
* прям не хватает setup & teardown методов
* вижу проблемы что между шагами трудно передать данные, либо я не понял как. Видел есть _reportDict в Context, но пока не понял для этого ли делалось. В идеале бы конечно сделать так, чтобы из шага можно было брать, а не из контекста
* Прокинуть OnApplicationQuit из клиента во вреймворк.
* Можно сделать генерацию Id шагов автоматически.
* Написать бы тесты чтобы проверять конфиги.

# что я улучшил (по моему мнению :D)
* добавил вывод степа перед фейлом в log.txt
* для чекера CellCount добавил GetCellCount() метод
* добавил команду WaitWorkbenchSawmillProgressCompleteCommand, чтобы трекать когда закончится отработка
* переименовал некоторые методы в Context, чтобы лучше отражало свои функции
* сделал TimeOut и GetArgs() в шагах виртуальными, чтобы не переопределять для каждого шага
* Сделал свой метод для определения имени иконки предмета, через .GetComponentsInChildren<Image>, но можно добавить определение CellContainer во вреймворке.
